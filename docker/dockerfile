# Этап сборки фронтенда
FROM node:18-alpine as frontend-builder

WORKDIR /app

# Копируем необходимые файлы для сборки фронтенда
COPY package.json tailwind.config.js ./
COPY src/main/resources/static/css/tailwind.css ./css/

# Устанавливаем зависимости и собираем CSS с помощью Tailwind
RUN npm install
RUN npx tailwindcss -i ./css/tailwind.css -o ./css/output.css --minify

# Этап сборки Java
FROM maven:3.8.6-eclipse-temurin-21 as backend-builder

WORKDIR /app

# Копируем все файлы проекта
COPY . .

# Копируем сгенерированный CSS из предыдущего этапа
COPY --from=frontend-builder /app/css/output.css /app/src/main/resources/static/css/

# Собираем Java-приложение
RUN mvn clean package -DskipTests

# Финальный образ
FROM eclipse-temurin:21-jre-jammy

WORKDIR /app

# Копируем собранный JAR файл из предыдущего этапа
COPY --from=backend-builder /app/target/*.jar app.jar

# Открываем порт 8080
EXPOSE 8080

# Команда для запуска приложения
ENTRYPOINT ["java", "-jar", "app.jar"]
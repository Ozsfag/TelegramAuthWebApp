# Этап сборки фронтенда
FROM node:18-alpine as frontend-builder

WORKDIR /app

# Установка Tailwind CSS глобально (самый надежный способ)
RUN npm install -g tailwindcss postcss autoprefixer

# Копируем файлы для сборки CSS
COPY tailwind.config.js ./
COPY src/main/resources/static/css/tailwind.css ./css/

# Собираем CSS
RUN tailwindcss -i ./css/tailwind.css -o ./css/output.css --minify

# Этап сборки Java (используем JDK 21)
FROM eclipse-temurin:21-jdk-alpine as backend-builder

WORKDIR /app

# Устанавливаем Maven вручную
RUN apk add --no-cache maven

# Копируем весь проект
COPY . .

# Копируем сгенерированный CSS
COPY --from=frontend-builder /app/css/output.css /app/src/main/resources/static/css/

# Собираем Java-приложение
RUN mvn clean package -DskipTests

# Финальный образ (JRE 21)
FROM eclipse-temurin:21-jre-alpine

WORKDIR /app

COPY --from=backend-builder /app/target/*.jar app.jar

EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]